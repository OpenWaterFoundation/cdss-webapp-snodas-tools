<html>
<head>
    <title> SNODAS Daily SWE and Snow Coverage Statistics </title>

    <!-- Include css files and a favicon icon -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
    <link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/L.Control.MousePosition.css"/>
    <link rel="stylesheet" href="css/leaflet.zoomhome.css"/>
    <!-- <link rel="stylesheet" href="css/lightbox.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="images/snodas-tools-favicon.ico"/>

    <!-- Include javascript files -->
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="javascript/L.Control.MousePosition.js"></script>
    <!-- <script src="javascript/lightbox.js"></script> -->
    <script src="javascript/leaflet.zoomhome.min.js"></script>
    <script src="javascript/papaparse.js"></script>
</head>

<script>
    /* This function is when users resize the browser. It should updated the 
    size of the map and surrounding elements to fit the broswer height and
    width. TODO: Fix element widths to work properly and resize on load.*/
    function resize_windows() 
    {
        var header_width = $("header").width();
        var nav_width = $("nav").width();
        var article_width = $("article").width();
        var aside_width = $("aside").width();
        var footer_width = $("footer").width();
        /* ASSIGN MAPID */
        $("#mapid").css("width",(header_width-nav_width-aside_width));
    }
</script>
<!-- If at anytime there is code that starts with the letter 'L', that is the command used by Leaflet. -->
<body onresize='resize_windows()'>
<header>
    <h1>Colorado's Decision Support Systems (CDSS) SNODAS Tools</h1>
</header>
<div id="main">

    <nav id="navbar" style="max-width: 350px; min-width: 350px;">
        <ul>
            <li><a style="font-family: Trebuchet, Helvetica,sans-serif!important;" id="aboutA" class="active" onclick="navbarClick('about',['data','analysis'],'aboutA');return false;">About</a></li>
            <li><a style="font-family: Trebuchet, Helvetica,sans-serif!important;" id="dataA" class="not-active" onclick="navbarClick('data',['about','analysis'],'dataA');return false;">Data</a></li>
            <li><a style="font-family: Trebuchet, Helvetica,sans-serif!important;" id="analysisA" class="not-active" onclick="navbarClick('analysis',['about','data'],'analysisA');return false;">Analysis</a></li>
        </ul>
        <div id="about" class="scroll">
            <h3>Daily SNODAS Snow Statistics for Colorado Watershed Basins</h3>
            <p>This website provides access to a historical archive of SNODAS data products for Colorado water supply basins. <a href="https://nsidc.org/data/g02158">Snow Data Assimilation System (SNODAS)</a> data are processed daily to calculate Snow Water Equivalent (SWE) and Snow Coverage statistics for water supply basins in Colorado. Snow Water Equivalent is the estimate of the depth of liquid water contained within the snowpack. Snow coverage is a percent of the basin land surface covered by snow (water bodies in the basin are ignored). The national SNODAS gridded dataset has been processed to provide data products for Colorado. Mean SWE is displayed in the map using a legend similar to the National Weather Service. The SNODAS Tools website provides access to an archive of daily products.</p>
            <ul>
                <li>The website is best viewed on a widescreen display. If the layout seems out of order press <span style="font-weight: bold">Ctrl and minus </span> to zoom out until the layout seems to be in correct order.</li>
                <li>Hover over a basin to see the daily mean SWE value and other daily statistics.</li>
                <li>Use the <span style="font-weight: bold;">Select Date</span> button to display historical data for a specified day.</li>
                <li>Enter animation start and end dates, press <span style="font-weight: bold;">Submit</span>, and then press the play button to view the animation of daily SWE data.</li>
                <li>Click on a basin in the map to select the basin or use the <span style="font-weight: bold">Select Basin</span> to select from the basin list. Then click on buttons in the lower right to display graphs.<li>
                <li>Reposition the map by holding the mouse button down and dragging.</li>
                <li>Zoom in and out of the map using the control in the upper left, or use the mouse wheel.</li>
                <li>Use the <span style="font-weight: bold;">Data</span> tab on the left to access raw data.</li>
            </ul>
            <p>&nbsp;</p>
            <p>Development of the SNODAS Tools was funded by the <a href="http://cwcb.state.co.us">Colorado Water Conservation Board</a>.  The tools were developed by the <a href="http://openwaterfoundation.org">Open Water Foundation</a>.
            Project resources are available on the<a href="http://projects.openwaterfoundation.org/owf-proj-co-cwcb-2016-snodas"> OWF SNODAS project website</a></p>
            <p style="font-weight: bold;">This website is under development with a scheduled completion date of June 30, 2017.  It is likely that changes in the site’s functionality and access to data will occur until then.</p>
            <p>Website version 1.0.1 (2017-03-20)</p>
            </div>
            <div id="data" class="scroll" style="display: none; min-width: 300px;">
                <h3>The input data and results from analysis will be made available soon, as details of the operational website are finalized.</h3>

                <p>The national SNODAS data are available from the <a href="https://nsidc.org/data/g02158">Snow Data Assimilation System (SNODAS)</a>.  The SNODAS data are processed into statistical data products by the CDSS SNODAS Tools.   The output consists of comma-separated-value (CSV) files <span style="font-weight: bold">“ByDate”</span> (basin data for each day) and <span style="font-weight: bold">“ByBasin”</span> (historical period for each basin).  Data files can be downloaded using the download buttons in the interface as well as by accessing the following URL resources.  The zip file contains a shapefile with daily statistics in the attribute table (names have been truncated to adhere to shapefile limit).</p>

                <p style="font-size: 13px">http://projects.openwaterfoundation.org/owf-proj-co-cwcb-2016-snodas/prototype/SnowpackStatisticsByBasin/SnowpackStatisticsByBasin_Local_ID.csv</p>

                <p style="font-size: 13px">http://projects.openwaterfoundation.org/owf-proj-co-cwcb-2016-snodas/prototype/SnowpackStatisticsByDate/SnowpackStatisticsByDate_YYYYMMDD.csv</p>

                <p style="font-size: 13px">http://projects.openwaterfoundation.org/owf-proj-co-cwcb-2016-snodas/prototype/SnowpackStatisticsByDate/SnowpackStatisticsByDate_YYYYMMDD.geojson</p>

                <p style="font-size: 13px">http://projects.openwaterfoundation.org/owf-proj-co-cwcb-2016-snodas/prototype/SnowpackStatisticsByDate/SnowpackStatisticsByDate_YYYYMMDD.zip</p>
                
                <p style="font-size: 13px">The following static resources are also available:</p>

                <p style="font-size: 13px">http://projects.openwaterfoundation.org/owf-proj-co-cwcb-2016-snodas/prototype/json/CO_boundary.geojson    (State of Colorado rectangular boundary)</p>

                <p style="font-size: 13px">http://projects.openwaterfoundation.org/owf-proj-co-cwcb-2016-snodas/prototype/json/SNODAS_geometry.geojson      (basin boundaries, same as daily boundaries)</p>

                <p style="font-size: 13px">xxxx/xxx .zip    (input basin boundary layer shapefile)</p>

                <p style="font-size: 13px">xxxx/Watershed_Connectivity_v3.xlsx    (input basin connectivity shapefile for total basin calculations)</p>

                <p>Refer to the <a href="http://software.openwaterfoundation.org/cdss-app-snodas-tools-doc-user/">SNODAS Tools User Manual</a> and <a href="http://software.openwaterfoundation.org/cdss-app-snodas-tools-doc-dev/">SNODAS Tools Developer Manual</a> for more information.</p>

                <h6>SNODAS data citation:  
                National Operational Hydrologic Remote Sensing Center. 2004. Snow Data Assimilation System (SNODAS) Data Products at NSIDC, Version 1.  SWE dataset.  Boulder, Colorado USA. NSIDC: National Snow and Ice Data Center. doi: http://dx.doi.org/10.7265/N5TB14TC.  Data are accessed daily, and historical period is also accessed as needed for historical period products.</h6>
            </div>
            <div id="analysis" style="display: none;">
                <h3>SNODAS data are processed into data products using QGIS and Python software as follows:</h3>
                <ol>
                    <li>Download daily SNODAS SWE national data.</li>
                    <li>Clip the national data to the extent of the Colorado water supply basin boundaries and save as TIF image.  Basins extend outside of the Colorado boundary.</li>
                    <li>Use the Colorado SNODAS SWE TIF image and water supply basin boundaries to calculate statistics for the basins.  The effective area used in calculations is that of the sum of the SNODAS grid cells, which differs slightly from the original basin boundary area.  SNODAS analysis excludes water bodies.</li>
                    <li>Output results to comma-separated-value (CSV), GeoJSON map layer, and zipped shapefile.   CSV files are generated by basin and by date to facilitate use in the website and by other applications.</li>
                    <li>Process CSV files into time series graph products.</li>
                    <li>Publish files to the SNODAS website.</li>
                </ol>
                <p>&nbsp;</p>
                <p>&nbsp;</p>
                <p>A summary of the analysis steps are described in the <a href="http://software.openwaterfoundation.org/cdss-app-snodas-tools-doc-user/">SNODAS Tools User Manual</a>. More detailed explanation are provided in the <a href="http://software.openwaterfoundation.org/cdss-app-snodas-tools-doc-dev/">SNODAS Tools Developer Manual</a>.</p>
            </div>

            <script>
                /* navbarClick() is a function that is called by the 
                about and data buttons on the navbar. This will
                set which class is active (which text is highlighted) 
                and then show the proper 'hidden' information that is 
                in the code above. */
                function navbarClick(source, other, source_id)
                {
                    if(source.toString() == "analysis")
                    {
                        $('#analysisA').removeClass('not-active');
                        $('#analysisA').addClass('active');
                        $('#aboutA').removeClass('active')
                        $('#aboutA').addClass('not-active');
                        $('#dataA').removeClass('active');
                        $('#dataA').addClass('not-active');
                    }
                    if(source.toString() == "data")
                    {
                        $('#dataA').removeClass('not-active');
                        $('#dataA').addClass('active');
                        $('#aboutA').removeClass('active')
                        $('#aboutA').addClass('not-active');
                        $('#analysisA').removeClass('active')
                        $('#analysisA').addClass('not-active');
                                        }
                    if(source.toString() == "about")
                    {
                        $('#aboutA').removeClass('not-active')
                        $('#aboutA').addClass('active');
                        $('#dataA').removeClass('active');
                        $('#dataA').addClass('not-active');
                        $('#analysisA').removeClass('active')
                        $('#analysisA').addClass('not-active');
                    }
                    for(var index in other)
                    {
                        document.getElementById(other[index]).style.display = "none";
                    }
                    document.getElementById(source).style.display = "block";
                }
            </script>
    </nav>

    <article>
        <div id="mapid" style="min-width: 300px; max-width: 1000px;">
            <script>
                /* Create Leaflet Map */
                var map = L.map('mapid', {zoomControl: false}).setView([38.99, -105.54], 7);
                
                L.tileLayer('https://api.mapbox.com/styles/v1/korysam/cixur5uy7003g2sqwthpjmbxa/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoia29yeXNhbSIsImEiOiJjaXd4dDRxbTQwMXRkMm9tZzd5b3BqdTBwIn0.A2EGyNrWG2Lbbd5c-I-94w', {
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
                    maxZoom: 18     
                }).addTo(map);

                /* Top Left Corner of Map. Allows for a home button to reset
                to the default zoom. */
                var zoomHome = L.Control.zoomHome();
                zoomHome.addTo(map);

                /* Bottom Right corner. This shows the current lat and long 
                of the mouse cursor. */
                L.control.mousePosition({position: 'bottomright',lngFormatter: function(num) {
                    var direction = (num < 0) ? 'W' : 'E';
                    var formatted = Math.abs(L.Util.formatNum(num, 3)) + 'º ' + direction;
                    return formatted; 
                },
                latFormatter: function(num) {
                    var direction = (num < 0) ? 'S' : 'N';
                    var formatted = Math.abs(L.Util.formatNum(num, 3)) + 'º ' + direction;
                    return formatted;
                }}).addTo(map);

                /* Bottom Right corner. This shows the scale in km and miles of
                the map. */
                L.control.scale({position: 'bottomright',imperial: true}).addTo(map);

                /* Functions below created by Emma. getColor is called by the onEachFeature
                method. This is what controls the color of each basin depending on the 
                Mean SME data value. This also controls the colors that are shown in the legend. */
                function getColor(d) {
                    return d < 0.02 ? '#ffffff':
                    d < 0.04 ? '#eff3ff':
                    d < 0.2 ? '#bdd7e7':
                    d < 0.4 ? '#6baed6':
                    d < 1.0 ? '#3182bd':
                    d < 2.0 ? '#08519c':
                    d < 4.0 ? '#49006a':
                    d < 6.0 ? '#7a0177':
                    d < 10.0 ? '#ae017e':
                    d < 20.0 ? '#dd3497':
                    d < 30.0 ? '#f768a1':
                    d < 40.0 ? '#fa9fb5':
                    d < 80.0 ? '#fcc5c0':
                    '#fde0dd';
                }

                var geojson;
                /* The function below is called when adding the geojson data from the SNODAS files.
                Style controls the fill color of each basin, the weight of the lines surrounding the 
                basin, the color of the lines outlining each basin, and the opacity. */                 
                function style(feature){
                    return {
                        fillColor: getColor((feature.properties.SNODAS_SWE_Mean_in == undefined ? feature.properties.SWE_Mean_inches:feature.properties.SNODAS_SWE_Mean_in)),
                        weight: 1, 
                        color: 'black',
                        fillOpacity: 0.60
                    };
                }

                /* This feature is used for the CO_boundary style. It sets the weight of the line used
                to border Colorado, the color of that line, and sets the fill opacity to 0. */
                function CO_Style(feature){
                    return {
                    // fillColor: getColor(feature.properties.Mean_inches),
                    weight: 5, 
                    color: 'black',
                    fillOpacity: 0,
                };
                }

                /* This feature is called by the onEachFeature method. It is what allows users to 
                highlight over basins and will pop up a gray line outlining the basin. */   
                function highlightFeature(e) {
                    var layer = e.target;
                    layer.setStyle({
                        weight: 6,
                        color: '#666',
                        dashArray: '',
                        
                    });

                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        layer.bringToFront();
                    }
                    
                    info.update(layer.feature.properties);
                }
                
                /* This function is also called by the onEachFeature method. It is used
                once a basin has been highlighted over, then the user moves the mouse it will
                reset the layer back to the original state. */
                function resetHighlight(e) {
                    geojson.resetStyle(e.target);
                    info.update();
                }
                
                /* This function is called by the onEachFeature method. It is used
                if a user clicks on a basin. It will automatically fit the basin to the map size
                    and zoom in on the indiviudal basin selected */
                function zoomToFeature(e) {
                    // map.fitBounds(e.target.getBounds());
                    SetSNODASPlot(e.target.feature.properties.LOCAL_ID);
                }

                /* This method is used when adding the SNODAS data to the map. It makes every object
                in the data have these certain "properties". So each object will have a mouseover,
                mouseout, and click property. All of these properties allow users to highlight over
                basins, and click on basins to zoom in on  them */
                function onEachFeature(feature, layer) {
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: resetHighlight,
                        click: zoomToFeature
                    });
                    layer._leaflet_id = feature.properties.LOCAL_ID;

                }

                /* This function is used to imitate the fire event 'mouseover'.
                It is called when a user selects a basin from the selct basin button.
                Once a basin is selected this method will imitate a user moving the 
                cursor over a basin. This function takes in a LOCAL_ID and will highlight
                the currently selected basin. */
                function clickOnMapItem(itemId) {
                    var id = itemId;
                    //get target layer by it's id
                    var layer = geojson.getLayer(id);
                    //fire event 'click' on target layer 
                    layer.fireEvent('mouseover');
                    SetSNODASPlot(itemId);
                }

                /* The below code is used to create the informational legend on the map. 
                info.update is used to call the statistics for each basin. It will check
                if props.SNODAS_ is undefined. If it is undefined it will call the props.SWE_.*/
                var info = L.control({position: 'bottomleft'});

                info.onAdd = function(map){
                    this._div = L.DomUtil.create('div', 'info');
                    this.update();
                    return this._div;
                };

                info.update = function(props) {
                    this._div.innerHTML = '<h4> Daily Basin Statistics </h4>' +  (props ? "<br><b>Local Name: </b>" + props.LOCAL_NAME + 
                        "<br><b>Local ID: </b>" + props.LOCAL_ID + "<br>" + "<br><b><u> SWE (millimeters | inches)</b></u>" + "<br><b>Mean: </b>" 
                        + Math.round(props.SNODAS_SWE_Mean_mm) + " mm | "
                        + setOneNumberDecimal(props.SNODAS_SWE_Mean_in) + " in"
                        + "<br><b>Effective Area: </b>"
                        + setOneNumberDecimal(props.SNODAS_EffectiveArea_sqmi) + " sqmi"
                        + "<br><b>Volume: </b>" 
                        + Math.round(props.SNODAS_SWE_Volume_acft) + " acft"
                        + "<br><b>Volume 1 Week Change: </b>"
                        + Math.round(props.SNODAS_SWE_Volume_1WeekChange_acft) + " acft"
                        + "<br>" + "<br><b>Snow Cover: </b>" 
                        + setTwoNumberDecimal(props.SNODAS_SnowCover_percent) + "%"
                        :'Hover over a basin');
                };

                /* This function is called by the legend and will round
                to the hundredths position (two decimal places). */
                function setTwoNumberDecimal(event) {
                    event = parseFloat(event).toFixed(2);
                    return event;
                }

                /* This function is called by the legend and will round
                to the tenths position (one decimal place). */
                function setOneNumberDecimal(event) {
                    event = parseFloat(event).toFixed(1);
                    return event;
                }

                info.addTo(map);    
                
                /* This code below creates the legend on the map. It iterates through
                an array of "grades" (snow melt in inches). It then adds this to the 
                legend and will create the html code required to do so */
                var legend = L.control({position: 'topright'});

                legend.onAdd = function (map) {

                    var div = L.DomUtil.create('div', 'info legend'),

                    grades = [0,0.02,0.04,0.2,0.4,1,2,4,6,10,20,30,40,80],
                        /* Referenced legend from this website. https://www.nohrsc.noaa.gov/snow_model/images/full/National/nsm_swe/201701/nsm_swe_2017012005_National.jpg
                        grades = [0,0.02,0.04,0.2,0.39,0.98,2,3.9,5.9,9.8,20,30,39,79], */
                        labels = ['<strong>Mean SWE' + '<br>(in)</strong>'],
                        from, to;

                        for (var i = 0; i < grades.length; i++) {
                            from = grades[i];
                            to = grades[i + 1];

                            labels.push(
                                '<i style="background:' + getColor(from + 0) + '"></i>&nbsp; ' +
                                from + (to ? '&ndash;' + to : '+'));
                        }

                        div.innerHTML = labels.join('<br>');
                        return div;
                    };
                    legend.addTo(map);
            </script>
        </div>
    </article>

    <aside>
        <div id="animation" style="background-color: #D3D3D3;">
            <div class="dropdown">
                <button onclick="myFunction()" class="dropbtn" style="font-size: 15px;">Select Date</button>&nbsp;<span id="SNODASTitle" style="font-size: 15px;">SNODAS Date:</span><span id="FileDate" style="font-size: 15px;"></span>
                <div id="myDropdown" class="dropdown-content">
                    <input type="text" placeholder="Search.." id="myInput" onkeyup="filterFunction()">
                    <div id="ListOfDates">
                        <script>
                            $.ajaxSetup({
                                async: false
                            });
                            var Current_Date, Latest_Date;
                            var text = new Array();
                            $.get("SnowpackStatisticsByDate/ListOfDates.txt",function(data)
                            {
                                text = data.split('\n');
                                /* Sort the dates in descending order (Most recent day first) */
                                text.sort(function(a, b) {
                                    return b - a;
                                });
                                /* trim each element. For some reason the split keeps the newline
                                delimiter. */
                                for(var date in text)
                                {
                                    text[date] = text[date].trim();
                                }
                                Current_Date = text[0];
                                Latest_Date = text[text.length-2];
                                document.getElementById('ListOfDates').appendChild(createDateList(text));
                            });

                            /* createDateList will create a ul, li list that contains all the dates of
                            available geojson files of the SNODAS data */
                            function createDateList(text)
                            {   
                                var list = document.createElement('span');
                                text.forEach(function(result) {
                                    // var item = document.createElement('li');
                                    var a = document.createElement('a');
                                    var date = document.createTextNode(result.substr(0,4) + "-" + result.substr(4,2) + "-" + result.substr(6,2));
                                        a.setAttribute("href","#");
                                        a.setAttribute("onclick", "updateFile(" + result + ");document.getElementById('myDropdown').classList.toggle('hide');return false;");
                                    a.appendChild(date);
                                    list.appendChild(a);
                                });
                                return list;
                            }
                        </script>
                    </div>
                </div>
            </div>
            <script>
                /* Grabs the data from CO_boundary.geojson and adds it as a
                layer to the map. This is what creates the big black border around
                Colorado */
                $.getJSON("json/CO_boundary.geojson",function(data){
                    L.geoJSON(data, {style: CO_Style}).addTo(map);
                });

                /* The below code grabs the SNODAS data fromt he fie file SnowpackbyDate_(CURRENT DATE).csv. It then assigns that data/object into the SNODAS_Statistics variable. */
                var SNODAS_FILE = "SnowpackStatisticsByDate/SnowpackStatisticsByDate_" + Current_Date + ".csv";
                var SNODAS_Statistics;
                $.get(SNODAS_FILE, function(data)
                {
                    SNODAS_Statistics = Papa.parse(data, { header: true, skipEmptyLines: true, quotes: true});
                });
                /* The below code grabs the SNODAS data from the file SNODAS_geometry.
                It then assigns that data/object into the SNODAS_Geometry variable */
                var SNODAS_Geometry = (function() {
                    var result;
                    $.getJSON("json/SNODAS_geometry.geojson",function(data) {
                        result = data;
                    }); return result;
                })();
                /* This call below merges the Geometry data with the statistics of each basin. 
                It then adds that merged object to the map as a layer allowing users to see
                the SNODAS data visually on the map. */
                geojson = L.geoJson(MergeData(SNODAS_Geometry,SNODAS_Statistics), {style: style, onEachFeature: onEachFeature}).addTo(map);
                // DeleteData(SNODAS_Geometry,SNODAS_Statistics);


                /* This funtion takes in a SNODAS Geometry geojson file and a Properties file 
                that contains multiple objects. Each object contains the statistics/data of each
                basin. This function than merges those properties into the SNODAS Geometry file and
                returns this new object. */
                function MergeData(SNODAS_Geometry, SNODAS_Statistics)
                {
                    for(var index in SNODAS_Geometry.features)
                    {
                        for(var key in SNODAS_Statistics["data"][index])
                        {
                            SNODAS_Geometry.features[index]["properties"][key] = SNODAS_Statistics["data"][index][key];
                        }
                    }
                    return SNODAS_Geometry;
                }

                /* This function takes in a SNODAS Geometry geojson file and a Properties file
                that contains multiple objects. Each object contains the statistics/data of each
                basin. This function than deletes those properties after the new leaflet layer has
                been added. (This function is used since there are two different header columns
                within the SNODAS CSV DATA files). */
                function DeleteData(SNODAS_Geometry, SNODAS_Statistics)
                {
                    for(var index in SNODAS_Geometry.features)
                    {
                        for(var key in SNODAS_Statistics)
                        {
                            if(SNODAS_Geometry.features[index]["properties"][SNODAS_Statistics[key]] != undefined)
                            {
                                var temp = SNODAS_Statistics[key];
                                delete SNODAS_Geometry.features[index]["properties"][temp];
                            }
                        }
                    }
                }

                /* This function is called by the elements in the ul, li list created for the dropdown
                menu. Once called, it will construct the file name and get the data from that SNODAS file.
                This data is than added to the original SNODAS Geometry data file and added to the map as a layer.
                The function will then remove the OLD SNODAS Geometry layer so there will be no overlap on the map. */
                function updateFile(file)
                {
                    var PropertyArray = ['SWE_Mean_meters','SWE_Minimum_meters','SWE_Maximum_meters','SWE_StdDev_meters','Count_pixels','SnowCover_percent','SWE_Mean_inches','SWE_Min_inches','SWE_Max_inches','SWE_StdDev_inches','SNODAS_SWE_Mean_m','SNODAS_SWE_Min_m','SNODAS_SWE_Max_m','SNODAS_SWE_StdDev_m','SNODAS_Pixels_Count','SNODAS_SnowCover_percent','SNODAS_SWE_Mean_in','SNODAS_SWE_Min_in','SNODAS_SWE_Max_in','SNODAS_SWE_StdDev_in'];
                    var FileName = file.toString();
                    FileName = FileName.substr(0,4) + "-" + FileName.substr(4,2) + "-" + FileName.substr(6,2);
                    file = "SnowpackStatisticsByDate/SnowpackStatisticsByDate_" + file + ".csv";
                    d3.selectAll("#FileDate").text(" " + FileName);
                    geojson.clearLayers();

                    $.get(file, function(data) {
                       data_array = Papa.parse(data, { header: true, skipEmptyLines: true});
                    });
                    // DeleteData(SNODAS_Geometry, PropertyArray);
                    geojson.addData(MergeData(SNODAS_Geometry,data_array));
                }
            </script>
            <h3 style="font-size: 17px">SNODAS Animation</h3>
            <form id="sliderInfo">
                <div id="StartDate" style="font-size: 15px;">
                    <script>
                        document.getElementById("StartDate").innerHTML = 
                        'Starting Date: (earliest available date: ' + 
                        Latest_Date.substr(0,4) + '-' + Latest_Date.substr(4,2)
                        + '-' + Latest_Date.substr(6,2) + ')';
                    </script>
                    <br>
                    <input type="text" name="startdate" placeholder="YYYY-MM-DD" required>
                    &nbsp;&nbsp;<i class="fa fa-question-circle" aria-hidden="true"><span class="tooltiptext">The starting date of data you would like to see.<br><br>For example: <ul><li>20161101</li><br><li>2016-11-01</li></ul></span></i>
                    <br><br>
                </div>

                <div id="EndDate" style="font-size: 15px;">
                    <script>
                        document.getElementById("EndDate").innerHTML = 
                        'Ending Date: (latest available date: ' + 
                        Current_Date.substr(0,4) + '-' + Current_Date.substr(4,2)
                        + '-' + Current_Date.substr(6,2) + ')'
                    </script>
                    <br>
                    <input type="text" name="enddate" placeholder="YYYY-MM-DD" required>
                    &nbsp;&nbsp;<i class="fa fa-question-circle" aria-hidden="true"><span class="tooltiptext">The ending date of data you would like to see.<br><br>For example: <ul><li>20161130</li><br><li>2016-11-30</li></ul></span></i>
                    <br><br>
                </div>

                <span style="font-size: 15px;">Increment (days): (Default is set to 1)</span><br>
                <input type="text" name="incrementsize" placeholder="value between 1 and 10">
                &nbsp;&nbsp;<i class="fa fa-question-circle" aria-hidden="true"><span class="tooltiptext">The increment, in days, for the animation. A value of 1 will display every day's data. A value of 5 will display every fifth day.</span></i>
                <br><br>
                <input type="Submit" value="Submit" style="font-family: Trebuchet MS,Helvetica,sans-serif!important;" onclick="updateSliderMin_Max(this.form.startdate.value, this.form.enddate.value, this.form.incrementsize.value);return false;"/>
            </form>
            <input type="range" id="dateSlider" min="null" max="null" value="" step="1" list="ticks" onchange="showValue(this.value);return false;" style="width: 350px;" disabled>
            <div id="DataList">
            </div>
            <span id="range"></span>
            <br>
            <input type="Submit" value= &#9658 style="width: 75px;" onclick="PlaySlider()">
            <input type="Submit" value= &#10073;&#10073; style="width: 75px;" onclick="PauseSlider()">
            <input type="Submit" value= &#x21bb; style="width: 75px;" onclick="reload()">
            <script>
                var RangeDates = new Array();
                var range_size, startdate, interval, step, original_startdate;
                var has_complete = false;
                var has_reset = true;
                var iterations = 0;


                /* This is the function the reset button calls. This will reset the 
                range to the beginning date (startdate) and will update certain booleans
                so the animation can run properly */
                function reload()
                {
                    clearInterval(interval);
                    iterations = 0;
                    startdate = original_startdate;
                    document.getElementById("dateSlider").value = startdate;
                    showValue(startdate);
                    has_complete = false;
                    has_reset = true;
                    PlaySlider();
                }
                /* This function is in charge of playing/running the animation
                slider. It will progress through an array of dates that the 
                user inputted (startdate to enddate). Once it has reached the
                end the user must click the reset button in order to play the
                animation again. */
                function PlaySlider()
                {
                    if(has_complete == true)
                    {
                        return false;
                    }
                    if(iterations == 0)
                    {
                        original_startdate = startdate;
                    }
                    if(has_reset == true)
                    {
                        has_reset = false;
                        interval = setInterval(function(){
                        if(iterations % step == 0)
                        {
                            document.getElementById("dateSlider").value = this.startdate;
                            showValue(startdate.toString());
                        }
                        iterations++;
                        if(startdate == RangeDates[RangeDates.length])
                        {
                            has_complete = true;
                            clearInterval(interval);
                            iterations = 0;
                            return false;
                        }
                        startdate = RangeDates[iterations];
                        },875);
                    }
                }

                /* This function is called by the pause button. When the pause button 
                is clicked, it wil clear the interval that is created in PlaySlider. 
                This is what pauses the animation */
                function PauseSlider()
                {
                    clearInterval(interval);
                    has_reset = true;
                }

                /* ShowValue is called whenever the slidebar value is updated.
                It will select the span element with id='range' and update it's 
                value to the newValue. */
                function showValue(newValue)
                {
                    document.getElementById("range").innerHTML = newValue.substr(0,4) + "-" + newValue.substr(4,2) + "-" + newValue.substr(6,2);
                    updateFile(newValue);
                }

                /* updateSliderMin_Max is called whenever the submit button is selected.
                It will update the min and max value of the range (slidebar) element.
                This then also creates tick marks on the slidebar by an increment of 
                one. */
                function updateSliderMin_Max(startdate,enddate,scale)
                {
                    if(scale == undefined)
                    {
                        scale = 1;
                    }
                    console.log(scale);
                    iterations = 0;
                    has_complete = false;
                    has_reset = true;
                    clearInterval(interval);

                    // /* ERROR HANDLING */
                    // /* Stardate must match format YYYYMMDD or YYYY-MM-DD */
                    // itartdate.match(/^\d{4}\-\d{1,2}\-\d{1,2}$/) && !startdate.match(/^\d{8}$/) ^ stardate == "")
                    // {
                    //     alert("Incorrect format for Starting Date value!");
                    //     return false;
                    // }
                    // /* Enddate must match format YYYYMMDD or YYYY-MM-DD */
                    // else if(!enddate.match(/^\d{4}\-\d{1,2}\-\d{1,2}$/) && !enddate.match(/^\d{8}$/) ^ enddate == "")
                    // {
                    //     alert("Incorrect format for Ending Date value!");
                    //     return false;
                    // }
                    // /* Increment must match format (int) or (int)(int) EX: 1 or 10. Must be between 1 and 10*/
                    // else if(!scale.match(/^\d{1}$/) && !scale.match(/^\d{1,2}$/) && scale != "" ^ scale > 10 ^ scale != "")
                    // {
                    //     alert("Incorrect format for Increment value!")
                    //     return false;
                    // }

                    RangeDates = [];
                    has_reset = true;
                    if(startdate.match(/^\d{4}\-\d{1,2}\-\d{1,2}$/))
                    {
                        startdate = startdate.replace("-","");
                        startdate = startdate.replace("-","");
                    }
                    if(enddate.match(/^\d{4}\-\d{1,2}\-\d{1,2}$/))
                    {
                        enddate = enddate.replace("-","");
                        enddate = enddate.replace("-","");
                    }
                    step = scale;
                    this.startdate = startdate;
                    range_size = (enddate - startdate) + 1;
                    updateFile(startdate);
                    document.getElementById("dateSlider").min = startdate;
                    document.getElementById("dateSlider").value = startdate;
                    document.getElementById("dateSlider").max = enddate;
                    document.getElementById("dateSlider").step = scale;
                    document.getElementById("range").innerHTML = startdate.substr(0,4) + "-" + startdate.substr(4,2) + "-" + startdate.substr(6,2);

                    var datalist = document.createElement('datalist');
                    datalist.id = "ticks";
                    document.getElementById('DataList').innerHTML = "";
                    var start_index = text.indexOf(startdate);
                    var end_index = text.indexOf(enddate);
                    for(start_index; start_index >= end_index; start_index--)
                    {
                        RangeDates.push(text[start_index]);
                        var option = document.createElement('option');
                        option.appendChild(document.createTextNode(text[start_index]));
                        datalist.appendChild(option);
                    }
                    console.log(RangeDates);

                    // document.getElementById('DataList').appendChild(datalist);
                }

                SNODAS_FILE = SNODAS_FILE.replace("SnowpackStatisticsByDate/SnowpackStatisticsByDate_","");
                SNODAS_FILE = SNODAS_FILE.replace(".csv","");
                SNODAS_FILE = SNODAS_FILE.substr(0,4) + "-" + SNODAS_FILE.substr(4,2) + "-" + SNODAS_FILE.substr(6,2);
                d3.select("#FileDate").text(" " + SNODAS_FILE);
            </script>
            </div>
            <br>
            <br>
            <div style="background-color: #D3D3D3">
                <div class="dropdown">
                    <button onclick="myFunction2()" class="dropbtn" style="font-size: 15px;">Select Basin</button>&nbsp;<span id="CurrentBasin" style="font-size: 15px;"></span>
                    <div id="myDropdown2" class="dropdown-content">
                        <input type="text" placeholder="Search.." id="myInput2" onkeyup="filterFunction2()">
                        <div id="BasinList">
                            <script>
                                document.getElementById('BasinList').appendChild(createBasinList());
                                /* createDateList will create a ul, li list that contains all the dates of
                                available geojson files of the SNODAS data */
                                function createBasinList()
                                {   
                                    var list = document.createElement('ul');
                                    for(var index in SNODAS_Geometry.features)
                                    {
                                        var li = document.createElement('li');
                                        var a = document.createElement('a');
                                        a.setAttribute("href","#");
                                        a.setAttribute("onclick",'clickOnMapItem(' + '"' + SNODAS_Geometry.features[index]["properties"]["LOCAL_ID"] + '");');
                                        var basin = document.createTextNode("LOCAL_ID: " + SNODAS_Geometry.features[index]["properties"]["LOCAL_ID"] + " LOCAL_NAME: " + SNODAS_Geometry.features[index]["properties"]["LOCAL_NAME"]);
                                        a.appendChild(basin);
                                        li.appendChild(a);
                                        list.appendChild(li);
                                    }
                                    return list;
                                }
                            </script>
                        </div>
                    </div>
               </div>
               <br>
               <span id="BasinID" style="font-size: 15px; font-weight: bold; text-decoration:"></span>
               <br>
               <span id="BasinName" style="font-size: 15px; font-weight: bold; text-decoration:"></span>

                <br>
                <br>
                <button onclick="document.getElementById('Basin_SnowCover').style.display='inline';">SNODAS Snow Cover Graph</button>
                <br>
                <br>
                <button onclick="document.getElementById('Basin_SWE').style.display='inline';">SNODAS SWE Graph</button>
                <br>
                <br>
                <button onclick="document.getElementById('Basin_SWE_Volume').style.display='inline';">SNODAS SWE Volume Graph</button>
                <br>
                <br>
                <button onclick="document.getElementById('Basin_Swe_Volume_1WeekChange').style.display='inline';">SNODAS SWE 1 Week Change Graph</button>

                <div id="Basin_SnowCover" class="lightbox" style="display: none" onclick="document.getElementById('Basin_SnowCover').style.display='none'">
                    <table class="lightbox_table">
                    <tr>
                    <td class="lightbox_table_cell" align="center">
                        <div id="lightbox_content">
                            <img id="Basin_SnowCover_img" src="">
                        </div>
                    </td>
                    </tr>
                    </table>
                </div>

                <div id="Basin_SWE" class="lightbox" style="display: none" onclick="document.getElementById('Basin_SWE').style.display='none'">
                    <table class="lightbox_table">
                    <tr>
                    <td class="lightbox_table_cell" align="center">
                        <div id="lightbox_content">
                            <img id="Basin_SWE_img" src="">
                        </div>
                    </td>
                    </tr>
                    </table>
                </div>

                <div id="Basin_SWE_Volume" class="lightbox" style="display: none" onclick="document.getElementById('Basin_SWE_Volume').style.display='none'">
                    <table class="lightbox_table">
                    <tr>
                    <td class="lightbox_table_cell" align="center">
                        <div id="lightbox_content">
                            <img id="Basin_SWE_Volume_img" src="">
                        </div>
                    </td>
                    </tr>
                    </table>
                </div>

                <div id="Basin_Swe_Volume_1WeekChange" class="lightbox" style="display: none" onclick="document.getElementById('Basin_Swe_Volume_1WeekChange').style.display='none'">
                    <table class="lightbox_table">
                    <tr>
                    <td class="lightbox_table_cell" align="center">
                        <div id="lightbox_content">
                            <img id="Basin_Swe_Volume_1WeekChange_img" src="">
                        </div>
                    </td>
                    </tr>
                    </table>
                </div>

            <script>
                /* SetSNODASPlot is called whenever a basin is clicked. Once clicked,
                this function will recieve the LOCAL_ID of that basin and then update
                the SNDOAS Plots image section with the proper plot graph. This will
                then get updated everytime a new basin is selected */
                function SetSNODASPlot(name)
                {
                    document.getElementById("Basin_SnowCover_img").src = "SnowpackGraphsByBasin/" + name + "-SNODAS-SnowCover.png";
                    document.getElementById("Basin_SWE_img").src = "SnowpackGraphsByBasin/" + name + "-SNODAS-SWE.png";
                    document.getElementById("Basin_SWE_Volume_img").src = "SnowpackGraphsByBasin/" + name + "-SNODAS-SWE-Volume.png";
                    document.getElementById("Basin_Swe_Volume_1WeekChange_img").src = "SnowpackGraphsByBasin/" + name + "-SNODAS-SWE-Volume-1WeekChange.png";
                    document.getElementById("BasinID").innerHTML = "Selected Basin ID: " + name;
                    document.getElementById("BasinName").innerHTML = "Basin Name: " + getBasinName(name);

                }

                /* getBasinName takes in a basin id and will search through the 
                SNODAS_Geometry.json file to find the local name of the basin. It will
                then return the local name of the coinciding local id. */
                function getBasinName(id)
                {
                    for(var index in SNODAS_Geometry.features)
                    {
                        if(SNODAS_Geometry.features[index]["properties"]["LOCAL_ID"] == id)
                        {
                            console.log(SNODAS_Geometry.features[index]["properties"]["LOCAL_NAME"]);
                            return SNODAS_Geometry.features[index]["properties"]["LOCAL_NAME"];
                        }
                    }
                }
            </script>
            </div>
        </div>
    </aside>
</div>

<script>
    /* Below code is used to close the dropdown menus when a user
    clicks outside the dropdown menu. */
    window.onclick = function(event) {
      if (!event.target.matches('.dropbtn')) {

        var dropdowns = document.getElementsByClassName("dropdown-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    }
    
    /* Functions used for the dropdown menu. When the user clicks on the button
    toggle between hiding and showing the dropdown content. myFunction selects
    the dropdown element. */
    function myFunction() {
        document.getElementById("myDropdown").classList.toggle("show");
    }

    /* Functions used for the dropdown menu. When the user clicks on the button
    toggle between hiding and showing the dropdown content. myFunction selects
    the dropdown element. */
    function myFunction2() {
        document.getElementById("myDropdown2").classList.toggle("show");
    }

    /* filterFunction is used to grab the list of elements in the dropdown menu.
    This function also allows users to use the search key and will display 
    if there is a matching element. If there is nothing that mathces the search,
    then the function returns nothing and the dropdown menu will show that no elements
    match that search. */
    function filterFunction() {
        var input, filter, a, i;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        div = document.getElementById("myDropdown");
        a = div.getElementsByTagName("a");
        for (i = 0; i < a.length; i++) {
            if (a[i].innerHTML.toUpperCase().indexOf(filter) > -1) {
                a[i].style.display = "";
            } else {
                a[i].style.display = "none";
            }
        }
    }

    /* filterFunction is used to grab the list of elements in the dropdown menu.
    This function also allows users to use the search key and will display 
    if there is a matching element. If there is nothing that mathces the search,
    then the function returns nothing and the dropdown menu will show that no elements
    match that search. */
    function filterFunction2() {
        var input, filter, a, i;
        input = document.getElementById("myInput2");
        filter = input.value.toUpperCase();
        div = document.getElementById("myDropdown2");
        a = div.getElementsByTagName("li");
        for (i = 0; i < a.length; i++) {
            if (a[i].innerHTML.toUpperCase().indexOf(filter) > -1) {
                a[i].style.display = "";
            } else {
                a[i].style.display = "none";
            }
        }
    }
</script>

<footer id="footer">
    <h5>Created by <a href="http://openwaterfoundation.org/">Open Water Foundation</a> for <a href="http://cwcb.state.co.us/Pages/CWCBHome.aspx">Colorado Water Conservation Board</a></h5>
</footer>

</body>
</html>
